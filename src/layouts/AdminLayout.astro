---
/**
 * Admin Layout
 *
 * Layout for admin dashboard pages.
 * Requires admin authentication - redirects to home if not admin.
 */
import BaseLayout from "./BaseLayout.astro";
import { AdminLayoutClient } from "@/components/admin/AdminLayoutClient";
import { getAdminAuthData } from "@/lib/auth/server";

interface Props {
  title?: string;
  description?: string;
}

const { title = "管理画面", description = "盆栽帳 管理画面" } = Astro.props;

// Check admin authentication
const { user, isAdmin, csrfToken } = await getAdminAuthData(Astro);

// Redirect if not authenticated
if (!user) {
  return Astro.redirect("/login?redirect=/manage");
}

// Redirect if not admin
if (!isAdmin) {
  return Astro.redirect("/");
}

const currentPath = Astro.url.pathname;

// Create user object for client component
const adminUser = {
  id: user.id,
  name: user.name,
  email: user.email,
  avatarUrl: user.avatarUrl,
};
---

<BaseLayout title={title} description={description}>
  <AdminLayoutClient
    client:load
    currentPath={currentPath}
    user={adminUser}
  >
    <slot />
  </AdminLayoutClient>
</BaseLayout>
