---
/**
 * Top Page - Landing page for Bonsai-Cho
 *
 * Features:
 * - Hero section with primary/secondary CTAs
 * - Platform statistics (bonsai count, users, images)
 * - Public bonsai showcase (latest 6 items)
 * - Feature introduction cards
 */
import AppLayout from "@/layouts/AppLayout.astro";
import {
  Card,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { getAuthData } from "@/lib/auth/server";
import { getDb } from "@/lib/db/client";
import {
  getPublicStats,
  getPublicBonsaiShowcase,
  type PlatformStats as PlatformStatsType,
  type BonsaiShowcaseItem,
} from "@/lib/db/queries";
import PlatformStats from "@/components/common/PlatformStats.astro";
import BonsaiCardStatic from "@/components/bonsai/list/BonsaiCardStatic.astro";
import { ArrowRight } from "lucide-react";

// Get auth data to show appropriate CTA buttons
const { user } = await getAuthData(Astro);

// Fetch platform data (stats + showcase) with error handling
let stats: PlatformStatsType = { bonsaiCount: 0, userCount: 0, imageCount: 0 };
let showcaseBonsai: BonsaiShowcaseItem[] = [];

try {
  const db = await getDb(
    import.meta.env.TURSO_DATABASE_URL,
    import.meta.env.TURSO_AUTH_TOKEN
  );

  // Fetch in parallel for performance
  [stats, showcaseBonsai] = await Promise.all([
    getPublicStats(db),
    getPublicBonsaiShowcase(db, 6),
  ]);
} catch (e) {
  console.error("Failed to fetch top page data:", e);
  // Fallback: empty data, sections will be hidden
}

// Button styles for Astro templates (avoid asChild issues with Radix Slot)
const buttonBaseStyles =
  "cursor-pointer inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50";
const buttonPrimaryStyles = `${buttonBaseStyles} bg-primary text-primary-foreground shadow hover:bg-primary/90 h-12 px-8 text-base`;
const buttonSecondaryStyles = `${buttonBaseStyles} border border-primary/40 bg-background text-foreground shadow-sm hover:bg-primary/5 h-12 px-8 text-base`;
---

<AppLayout
  title="盆栽帳 - Bonsai-Cho"
  description="盆栽コレクションを記録し、愛好家と共有しましょう。成長を記録し、仲間とつながり、盆栽の芸術を楽しめます。"
>
  <!-- Hero Section -->
  <section class="relative overflow-hidden py-16 md:py-24">
    <div class="container-app">
      <div class="mx-auto max-w-3xl text-center">
        <h1 class="font-serif text-4xl font-bold tracking-tight text-foreground sm:text-5xl md:text-6xl">
          あなたの
          <span class="text-primary">盆栽</span>
          を記録しよう
        </h1>
        <p class="mt-6 text-lg leading-8 text-muted-foreground md:text-xl">
          盆栽の成長を記録し、写真を共有し、盆栽を愛する仲間とつながりましょう。
        </p>

        <!-- CTA Buttons -->
        <div class="mt-10 flex flex-col sm:flex-row items-center justify-center gap-4">
          {user ? (
            <a href="/bonsai/new" class={buttonPrimaryStyles}>
              盆栽を登録する
            </a>
          ) : (
            <a href="/login?returnTo=/bonsai/new" class={buttonPrimaryStyles}>
              今すぐ始める
            </a>
          )}
          <a href="/bonsai" class={buttonSecondaryStyles}>
            盆栽を見てみる
          </a>
        </div>
      </div>
    </div>

    <!-- Decorative background -->
    <div class="absolute inset-0 -z-10 overflow-hidden" aria-hidden="true">
      <div class="absolute left-1/2 top-0 h-[600px] w-[600px] -translate-x-1/2 -translate-y-1/2 rounded-full bg-primary/5 blur-3xl"></div>
    </div>
  </section>

  <!-- Stats Section -->
  <PlatformStats
    bonsaiCount={stats.bonsaiCount}
    userCount={stats.userCount}
    imageCount={stats.imageCount}
  />

  <!-- Bonsai Showcase Section -->
  {showcaseBonsai.length > 0 && (
    <section class="py-16 md:py-20" aria-labelledby="showcase-heading">
      <div class="container-app">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 mb-10">
          <div>
            <h2
              id="showcase-heading"
              class="font-serif text-2xl md:text-3xl font-bold text-foreground"
            >
              みんなの盆栽
            </h2>
            <p class="mt-2 text-muted-foreground">
              愛好家たちの美しい盆栽コレクション
            </p>
          </div>
          <a
            href="/bonsai"
            class="inline-flex items-center gap-1 text-primary hover:underline font-medium"
          >
            すべて見る
            <ArrowRight className="w-4 h-4" />
          </a>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
          {showcaseBonsai.map((bonsai) => (
            <BonsaiCardStatic
              id={bonsai.id}
              name={bonsai.name}
              description={bonsai.description}
              thumbnailUrl={bonsai.thumbnailUrl}
              speciesNameJa={bonsai.speciesNameJa}
              styleNameJa={bonsai.styleNameJa}
              likeCount={bonsai.likeCount}
              commentCount={bonsai.commentCount}
            />
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Features Section -->
  <section class="border-t border-border bg-muted/20 py-16 md:py-20">
    <div class="container-app">
      <div class="mx-auto max-w-2xl text-center">
        <h2 class="font-serif text-2xl md:text-3xl font-bold tracking-tight text-foreground">
          盆栽管理に必要なすべてを
        </h2>
        <p class="mt-4 text-lg text-muted-foreground">
          記録・共有・成長。盆栽管理プラットフォームで、あなたの盆栽ライフをサポートします。
        </p>
      </div>

      <div class="mt-12 grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
        <!-- Feature 1 -->
        <Card className="border-border bg-card shadow-card">
          <CardHeader>
            <div class="mb-4 flex h-12 w-12 items-center justify-center rounded-lg bg-primary/10 text-primary">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6" aria-hidden="true">
                <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                <circle cx="12" cy="13" r="3"/>
              </svg>
            </div>
            <CardTitle className="font-serif">フォトギャラリー</CardTitle>
            <CardDescription>
              盆栽コレクションの写真をアップロード・整理。時間の経過とともに変化を追跡できます。
            </CardDescription>
          </CardHeader>
        </Card>

        <!-- Feature 2 -->
        <Card className="border-border bg-card shadow-card">
          <CardHeader>
            <div class="mb-4 flex h-12 w-12 items-center justify-center rounded-lg bg-primary/10 text-primary">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6" aria-hidden="true">
                <path d="M12 20h9"/>
                <path d="M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z"/>
              </svg>
            </div>
            <CardTitle className="font-serif">お手入れ記録</CardTitle>
            <CardDescription>
              水やり、剪定、植え替えなどのお手入れ記録を詳細に残せます。
            </CardDescription>
          </CardHeader>
        </Card>

        <!-- Feature 3 -->
        <Card className="border-border bg-card shadow-card">
          <CardHeader>
            <div class="mb-4 flex h-12 w-12 items-center justify-center rounded-lg bg-primary/10 text-primary">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6" aria-hidden="true">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
              </svg>
            </div>
            <CardTitle className="font-serif">コミュニティ</CardTitle>
            <CardDescription>
              世界中の盆栽愛好家とつながりましょう。ヒントを共有し、フィードバックをもらい、一緒に学べます。
            </CardDescription>
          </CardHeader>
        </Card>
      </div>
    </div>
  </section>

</AppLayout>
