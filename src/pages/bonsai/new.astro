---
/**
 * Bonsai Create Page (Unified Form)
 *
 * Progressive disclosure form for creating a new bonsai.
 * Features: multiple image upload, collapsible details section.
 * Requires authentication - redirects to login if not authenticated.
 */
import AppLayout from "@/layouts/AppLayout.astro";
import { UnifiedBonsaiForm } from "@/components/bonsai/form";
import type { Species, Style } from "@/components/bonsai/form";
import { getAuthData } from "@/lib/auth/server";

// Auth check - redirect to login if not authenticated
const { user, csrfToken } = await getAuthData(Astro);

if (!user) {
  return Astro.redirect("/login?redirect=/bonsai/new");
}

// Fetch master data (species and styles) in parallel
let speciesList: Species[] = [];
let styleList: Style[] = [];
let fetchError: string | null = null;

try {
  const cookieHeader = Astro.request.headers.get("cookie") || "";

  const [speciesRes, stylesRes] = await Promise.all([
    fetch(`${Astro.url.origin}/api/masters/species`, {
      headers: { Cookie: cookieHeader },
    }),
    fetch(`${Astro.url.origin}/api/masters/styles`, {
      headers: { Cookie: cookieHeader },
    }),
  ]);

  if (speciesRes.ok) {
    const speciesData = await speciesRes.json();
    speciesList = speciesData.data || [];
  } else {
    fetchError = "樹種データの取得に失敗しました";
  }

  if (stylesRes.ok) {
    const stylesData = await stylesRes.json();
    styleList = stylesData.data || [];
  } else {
    fetchError = fetchError
      ? `${fetchError}、樹形データの取得にも失敗しました`
      : "樹形データの取得に失敗しました";
  }
} catch (e) {
  console.error("Error fetching master data:", e);
  fetchError = "マスターデータの取得に失敗しました";
}
---

<AppLayout
  title="盆栽を登録 | Bonsai-Cho"
  description="新しい盆栽をコレクションに追加します"
>
  <div class="container-app py-8">
    <!-- Breadcrumb -->
    <nav class="mb-6" aria-label="パンくずリスト">
      <ol class="flex items-center gap-2 text-sm text-muted-foreground">
        <li>
          <a href="/bonsai" class="hover:text-foreground transition-colors">
            盆栽コレクション
          </a>
        </li>
        <li aria-hidden="true">/</li>
        <li class="text-foreground font-medium">新規登録</li>
      </ol>
    </nav>

    <!-- Page Header -->
    <header class="mb-8">
      <h1 class="font-serif text-3xl font-bold text-foreground md:text-4xl">
        盆栽を登録
      </h1>
      <p class="mt-2 text-muted-foreground">
        あなたの盆栽をコレクションに追加しましょう
      </p>
    </header>

    <!-- Error State -->
    {fetchError && (
      <div class="rounded-lg bg-destructive/10 p-4 text-center text-destructive mb-8">
        <p>{fetchError}</p>
        <button
          onclick="window.location.reload()"
          class="mt-2 text-sm underline hover:no-underline"
        >
          再読み込み
        </button>
      </div>
    )}

    <!-- Form -->
    <div class="max-w-md mx-auto">
      <UnifiedBonsaiForm
        client:load
        csrfToken={csrfToken || ""}
        speciesList={speciesList}
        styleList={styleList}
        maxImages={5}
        onSuccess={(bonsaiId: string) => {
          window.location.href = `/bonsai/${bonsaiId}`;
        }}
        onCancel={() => {
          window.history.back();
        }}
      />
    </div>
  </div>
</AppLayout>
