---
/**
 * Bonsai Detail Page
 *
 * Displays bonsai details with gallery, like button, and comment section.
 * SSR fetches initial data for SEO and authenticated state.
 */
import AppLayout from "@/layouts/AppLayout.astro";
import { BonsaiGallery } from "@/components/bonsai/gallery";
import { LikeButton } from "@/components/social/LikeButton";
import { CommentSection } from "@/components/social/CommentSection";
import { Button } from "@/components/ui/button";
import { getAuthData } from "@/lib/auth/server";
import type { BonsaiDetailResponse } from "@/server/routes/bonsai.schema";

// Get route params
const { bonsaiId } = Astro.params;

if (!bonsaiId) {
  return Astro.redirect("/bonsai");
}

// Get auth data
const { user, csrfToken } = await getAuthData(Astro);

// SSR: Fetch bonsai detail and comments in parallel
let bonsai: BonsaiDetailResponse | null = null;
let comments = { data: [], hasMore: false, nextCursor: null as string | null };
let fetchError: string | null = null;

try {
  const cookieHeader = Astro.request.headers.get("cookie") || "";

  const [bonsaiRes, commentsRes] = await Promise.all([
    fetch(`${Astro.url.origin}/api/bonsai/${bonsaiId}`, {
      headers: { Cookie: cookieHeader },
    }),
    fetch(`${Astro.url.origin}/api/bonsai/${bonsaiId}/comments?limit=5`, {
      headers: { Cookie: cookieHeader },
    }),
  ]);

  if (bonsaiRes.status === 404) {
    return Astro.redirect("/bonsai");
  }

  if (!bonsaiRes.ok) {
    fetchError = "盆栽データの取得に失敗しました";
  } else {
    bonsai = await bonsaiRes.json();
  }

  if (commentsRes.ok) {
    comments = await commentsRes.json();
  }
} catch (e) {
  console.error("Error fetching bonsai detail:", e);
  fetchError = "盆栽データの取得に失敗しました";
}

// Check ownership
const isOwner = user?.id === bonsai?.userId;

// Format date helper
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString("ja-JP", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};
---

<AppLayout
  title={bonsai ? `${bonsai.name} | Bonsai-Cho` : "盆栽詳細 | Bonsai-Cho"}
  description={bonsai?.description || "盆栽の詳細情報とギャラリー"}
>
  <div class="container-app py-8">
    <!-- Error State -->
    {fetchError && (
      <div class="rounded-lg bg-destructive/10 p-8 text-center text-destructive">
        <p class="text-lg">{fetchError}</p>
        <a href="/bonsai" class="mt-4 inline-block text-sm underline hover:no-underline">
          一覧に戻る
        </a>
      </div>
    )}

    {bonsai && (
      <div class="grid gap-8 lg:grid-cols-[1fr,400px]">
        <!-- Main Content -->
        <div class="space-y-8">
          <!-- Header -->
          <header class="space-y-4">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h1 class="font-serif text-3xl font-bold text-foreground md:text-4xl">
                  {bonsai.name}
                </h1>
                {(bonsai.species || bonsai.style) && (
                  <p class="mt-2 text-lg text-muted-foreground">
                    {[bonsai.species?.nameJa, bonsai.style?.nameJa].filter(Boolean).join(" / ")}
                  </p>
                )}
              </div>

              {isOwner && (
                <div class="flex gap-2">
                  <Button variant="outline" asChild>
                    <a href={`/bonsai/${bonsaiId}/edit`}>編集</a>
                  </Button>
                  <Button variant="outline" asChild>
                    <a href={`/bonsai/${bonsaiId}/care-logs`}>お手入れ記録</a>
                  </Button>
                </div>
              )}
            </div>

            {bonsai.description && (
              <p class="text-foreground/90 whitespace-pre-wrap">
                {bonsai.description}
              </p>
            )}
          </header>

          <!-- Gallery -->
          <BonsaiGallery
            client:load
            bonsaiId={bonsaiId}
            images={bonsai.images}
            isOwner={isOwner}
            csrfToken={csrfToken || undefined}
          />

          <!-- Social Actions (Mobile) -->
          <div class="lg:hidden">
            <div class="flex items-center gap-4 p-4 bg-muted/30 rounded-xl">
              <LikeButton
                client:load
                bonsaiId={bonsaiId}
                initialLiked={bonsai.isLiked}
                initialCount={bonsai.likeCount}
                csrfToken={csrfToken || ""}
              />
              <span class="text-sm text-muted-foreground">
                {bonsai.commentCount}件のコメント
              </span>
            </div>
          </div>

          <!-- Comments -->
          <CommentSection
            client:load
            bonsaiId={bonsaiId}
            initialComments={comments.data}
            initialHasMore={comments.hasMore}
            initialNextCursor={comments.nextCursor}
            currentUserId={user?.id || null}
            bonsaiOwnerId={bonsai.userId}
            csrfToken={csrfToken || ""}
          />
        </div>

        <!-- Sidebar -->
        <aside class="space-y-6">
          <!-- Social Actions (Desktop) -->
          <div class="hidden lg:block sticky top-24">
            <div class="p-6 bg-muted/30 rounded-xl space-y-6">
              <LikeButton
                client:load
                bonsaiId={bonsaiId}
                initialLiked={bonsai.isLiked}
                initialCount={bonsai.likeCount}
                csrfToken={csrfToken || ""}
                size="lg"
              />

              <!-- Bonsai Info -->
              <div class="space-y-4 pt-4 border-t border-border">
                <h3 class="font-serif font-bold text-foreground">詳細情報</h3>
                <dl class="space-y-3 text-sm">
                  {bonsai.estimatedAge && (
                    <div class="flex justify-between">
                      <dt class="text-muted-foreground">推定樹齢</dt>
                      <dd class="font-medium">{bonsai.estimatedAge}年</dd>
                    </div>
                  )}
                  {bonsai.height && (
                    <div class="flex justify-between">
                      <dt class="text-muted-foreground">高さ</dt>
                      <dd class="font-medium">{bonsai.height}cm</dd>
                    </div>
                  )}
                  {bonsai.width && (
                    <div class="flex justify-between">
                      <dt class="text-muted-foreground">幅</dt>
                      <dd class="font-medium">{bonsai.width}cm</dd>
                    </div>
                  )}
                  {bonsai.acquiredAt && (
                    <div class="flex justify-between">
                      <dt class="text-muted-foreground">入手日</dt>
                      <dd class="font-medium">{formatDate(bonsai.acquiredAt)}</dd>
                    </div>
                  )}
                  {bonsai.potDetails && (
                    <div>
                      <dt class="text-muted-foreground mb-1">鉢の詳細</dt>
                      <dd class="font-medium">{bonsai.potDetails}</dd>
                    </div>
                  )}
                </dl>
              </div>

              <!-- Tags -->
              {bonsai.tags && bonsai.tags.length > 0 && (
                <div class="space-y-3 pt-4 border-t border-border">
                  <h3 class="font-serif font-bold text-foreground">タグ</h3>
                  <div class="flex flex-wrap gap-2">
                    {bonsai.tags.map((tag: { id: string; name: string }) => (
                      <span class="px-3 py-1 text-sm bg-primary/10 text-primary rounded-full">
                        {tag.name}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              <!-- Meta -->
              <div class="pt-4 border-t border-border text-xs text-muted-foreground">
                <p>登録日: {formatDate(bonsai.createdAt)}</p>
                <p>更新日: {formatDate(bonsai.updatedAt)}</p>
              </div>
            </div>
          </div>
        </aside>
      </div>
    )}
  </div>
</AppLayout>
